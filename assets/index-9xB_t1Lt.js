var Je=Object.defineProperty;var Ye=(n,s,e)=>s in n?Je(n,s,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[s]=e;var I=(n,s,e)=>(Ye(n,typeof s!="symbol"?s+"":s,e),e),Ee=(n,s,e)=>{if(!s.has(n))throw TypeError("Cannot "+e)};var t=(n,s,e)=>(Ee(n,s,"read from private field"),e?e.call(n):s.get(n)),c=(n,s,e)=>{if(s.has(n))throw TypeError("Cannot add the same private member more than once");s instanceof WeakSet?s.add(n):s.set(n,e)},a=(n,s,e,i)=>(Ee(n,s,"write to private field"),i?i.call(n,e):s.set(n,e),e);var P=(n,s,e)=>(Ee(n,s,"access private method"),e);import{d as j,a as A,p as l,D as et,r as tt,b as we,c as st,e as it,f as nt,g as rt,h as he,i as x,j as be,k as ot,T as S,C as Pe,l as $e,m as ct,$ as at,n as ht}from"./vendor-BPJiTkMn.js";(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const o of r)if(o.type==="childList")for(const u of o.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&i(u)}).observe(document,{childList:!0,subtree:!0});function e(r){const o={};return r.integrity&&(o.integrity=r.integrity),r.referrerPolicy&&(o.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?o.credentials="include":r.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(r){if(r.ep)return;r.ep=!0;const o=e(r);fetch(r.href,o)}})();const ze=j();function lt(){return(n,s)=>(A(n,ze,s),s)}const Ne=j();function ut(){return(n,s)=>(A(n,Ne,s),s)}var g,p;class dt{constructor(){c(this,g,new Map);c(this,p,new Map)}destroy(){t(this,g).clear(),t(this,p).clear()}unset(s,e){if(e)t(this,g).has(e)&&t(this,p).has(s)&&(t(this,g).get(e).delete(s),t(this,p).get(s).delete(e));else if(t(this,p).has(s)){for(const i of t(this,p).get(s))t(this,g).get(i).delete(s);t(this,p).delete(s)}}set(s,e,i){if(typeof e=="string")t(this,g).has(e)||t(this,g).set(e,new Map),t(this,p).has(s)||t(this,p).set(s,new Set),t(this,p).get(s).add(e),t(this,g).get(e).set(s,i);else if(typeof e=="object")for(const[r,o]of Object.entries(e))this.set(s,r,o)}get(s,e){if(e){if(t(this,g).has(e)&&t(this,p).has(s)&&t(this,p).get(s).has(e))return t(this,g).get(e).get(s)}else if(t(this,p).has(s)){let i={};for(const r of t(this,p).get(s))i[r]=t(this,g).get(r).get(s);return i}}}g=new WeakMap,p=new WeakMap;const Le=j();function De(){return(n,s)=>(A(n,Le,s),s)}function xe(...n){return(s,e)=>(n.forEach(i=>i==null?void 0:i(s,e)),e)}var h,T,v,_,D,ue,G,M,F,$,W,q,O,C,de;class pt extends l.Plugins.ScenePlugin{constructor(){super(...arguments);c(this,h,void 0);c(this,T,new Map);c(this,v,new Set);c(this,_,new Set);c(this,D,new Set);c(this,ue,null);c(this,G,null);c(this,M,null);c(this,F,null);c(this,$,null);c(this,W,null);c(this,q,null);c(this,O,new Set);c(this,C,new Set);c(this,de,!1)}async*outSync(){for(;!t(this,de);)yield new Promise(e=>{a(this,q,e)})}inSync({sync:e,requests:i}){e!=null&&e.byteLength&&t(this,O).add(e),i!=null&&i.byteLength&&t(this,C).add(i)}addSystem(e,i,r=!0){t(this,T).set(e,i),r&&t(this,v).add(e)}removeSystem(e){t(this,T).delete(e),t(this,v).delete(e)}disableSystem(e){t(this,v).delete(e)}enableSystem(e){t(this,v).add(e)}preUpdate(e,i){var r,o,u;if(t(this,D).size){for(const d of t(this,D))this.addEntity(d);t(this,D).clear()}if(t(this,_).size){for(const d of t(this,_))this.addEntity(d);t(this,_).clear()}if((r=t(this,q))==null||r.call(this,{sync:t(this,F).call(this,t(this,W).call(this,t(this,h))),requests:t(this,F).call(this,t(this,M).call(this,t(this,h)))}),t(this,O).size){const d=Array.from(t(this,O));t(this,O).clear();for(const m of d)for(const Q of t(this,$).call(this,t(this,h),m,et.MAP))tt(t(this,h),Le,Q)}if(t(this,C).size){const d=Array.from(t(this,C));t(this,C).clear();for(const m of d)t(this,$).call(this,t(this,h),m)}for(const d of t(this,v))(u=(o=t(this,T).get(d)).preUpdate)==null||u.call(o,t(this,h),e,i)}update(e,i){var r,o;for(const u of t(this,v))(o=(r=t(this,T).get(u)).update)==null||o.call(r,t(this,h),e,i)}postUpdate(e,i){var r,o,u,d;for(const m of t(this,v))(o=(r=t(this,T).get(m)).postUpdate)==null||o.call(r,t(this,h),e,i);for(const m of((u=t(this,G))==null?void 0:u.call(this,t(this,h)))||[])we(t(this,h),m);for(const m of((d=t(this,M))==null?void 0:d.call(this,t(this,h)))||[])we(t(this,h),m)}addEntity(...e){return xe(...e)(t(this,h),st(t(this,h)))}removeEntity(e){we(t(this,h),e)}emit(...e){e.length&&t(this,_).add(xe(lt(),...e))}request(...e){e.length&&t(this,D).add(xe(ut(),...e))}boot(){a(this,h,it({scene:this.scene,store:new dt})),a(this,F,nt(t(this,h))),a(this,$,rt(t(this,h))),a(this,W,he(x([Le]))),a(this,G,x([ze])),a(this,M,x([Ne])),this.scene.events.on(l.Scenes.Events.PRE_UPDATE,this.preUpdate,this),this.scene.events.on(l.Scenes.Events.UPDATE,this.update,this),this.scene.events.on(l.Scenes.Events.POST_UPDATE,this.postUpdate,this)}destroy(){this.scene.events.off(l.Scenes.Events.PRE_UPDATE,this.preUpdate),this.scene.events.off(l.Scenes.Events.UPDATE,this.update),this.scene.events.off(l.Scenes.Events.POST_UPDATE,this.postUpdate),t(this,v).clear(),t(this,T).clear(),t(this,_).clear(),t(this,D).clear(),be(t(this,h),t(this,G)),be(t(this,h),t(this,M)),be(t(this,h),t(this,ue)),ot(t(this,h))}}h=new WeakMap,T=new WeakMap,v=new WeakMap,_=new WeakMap,D=new WeakMap,ue=new WeakMap,G=new WeakMap,M=new WeakMap,F=new WeakMap,$=new WeakMap,W=new WeakMap,q=new WeakMap,O=new WeakMap,C=new WeakMap,de=new WeakMap;var Te=(n=>(n[n.Set=0]="Set",n[n.Add=1]="Add",n))(Te||{});const f=j({vec2:[S.f32,2]});function Ae(n,s){return(e,i)=>(A(e,f,i),ve(f.vec2[i],n,s),i)}const B=j({eid:S.eid,vec2:[S.f32,2],type:S.ui8}),R=j({mat2:[S.f32,4]});function Me(n,s,e,i){return(r,o)=>(A(r,R,o),Et(R.mat2[o],n,s,e,i),o)}var H,K,Re;let ft=(Re=class{constructor(){c(this,H,void 0);c(this,K,void 0);a(this,H,he(x([f,R]))),a(this,K,x([Pe(f),R]))}preUpdate(s){t(this,H).call(this,s).forEach(e=>{Qe(f.vec2[e],R.mat2[e])})}postUpdate(s){t(this,K).call(this,s).forEach(e=>{Qe(f.vec2[e],R.mat2[e])})}},H=new WeakMap,K=new WeakMap,Re);var X,Ge;let yt=(Ge=class{constructor(){c(this,X,void 0);a(this,X,he(x([B])))}preUpdate(s){t(this,X).call(this,s).forEach(e=>{const i=B.eid[e];if($e(s,f,i))switch(B.type[e]){case Te.Set:Be(f.vec2[i],B.vec2[e]);break;case Te.Add:ke(f.vec2[i],B.vec2[e]);break}})}},X=new WeakMap,Ge);const L=j({texture:S.ui8,depth:S.ui8});function Oe(n,s){return(e,i)=>(A(e,L,i),L.depth[i]=n,L.texture[i]=s,i)}var Z,z,V,J,Y,ee,Fe;let mt=(Fe=class{constructor({textures:s}){c(this,Z,void 0);c(this,z,void 0);c(this,V,void 0);c(this,J,void 0);c(this,Y,void 0);c(this,ee,void 0);a(this,Z,s),a(this,z,x([L])),a(this,V,he(t(this,z))),a(this,J,ct(t(this,z))),a(this,Y,x([Pe(f),L])),a(this,ee,x([Pe(L)]))}preUpdate(s){t(this,V).call(this,s).forEach(e=>{const{scene:i,store:r}=s,o=i.add.sprite(f.vec2[e][0],f.vec2[e][1],t(this,Z)[L.texture[e]]);o.setPosition(...f.vec2[e]),o.setDepth(L.depth[e]),o.setData({eid:e}),r.set(e,"sprite",o)})}update(s){t(this,Y).call(this,s).forEach(e=>{const i=s.store.get(e,"sprite");i instanceof l.GameObjects.Sprite&&i.setPosition(...f.vec2[e])}),t(this,ee).call(this,s).forEach(e=>{const i=s.store.get(e,"sprite");i instanceof l.GameObjects.Sprite&&i.setDepth(L.depth[e])})}postUpdate(s){t(this,J).call(this,s).forEach(e=>{const i=s.store.get(e,"sprite");i instanceof l.GameObjects.Sprite&&i.destroy(),s.store.unset(e,"sprite")})}},Z=new WeakMap,z=new WeakMap,V=new WeakMap,J=new WeakMap,Y=new WeakMap,ee=new WeakMap,Fe);var le=(n=>(n[n.Set=0]="Set",n[n.Add=1]="Add",n))(le||{});const b=j({vec2:[S.f32,2],max:S.f32});function Ce(n,s,e){return(i,r)=>(A(i,b,r),ve(b.vec2[r],n,s),b.max[r]=e,r)}const k=j({eid:S.eid,vec2:[S.f32,2],type:S.ui8});var te;class gt{constructor(){c(this,te,void 0);a(this,te,he(x([k])))}preUpdate(s){t(this,te).call(this,s).forEach(e=>{const i=k.eid[e];if($e(s,b,i)){switch(k.type[e]){case le.Set:Be(b.vec2[i],k.vec2[e]);break;case le.Add:ke(b.vec2[i],k.vec2[e]);break}xt(b.vec2[i],b.max[i])}})}}te=new WeakMap;function St(n,s,e){return(i,r)=>(A(i,k,r),k.type[r]=le.Set,k.eid[r]=n,ve(k.vec2[r],s,e),r)}var se;class vt{constructor(){c(this,se,void 0);a(this,se,x([b,f]))}update(s,e,i){t(this,se).call(this,s).forEach(r=>{je(b.vec2[r])||ke(f.vec2[r],b.vec2[r],i/1e3)})}}se=new WeakMap;function Et(n,s,e,i,r){n[0]=s,n[1]=e,n[2]=i,n[3]=r}function Be(n,s){n[0]=s[0],n[1]=s[1]}function ve(n,s,e){n[0]=s,n[1]=e}function ke(n,s,e=1){n[0]+=s[0]*e,n[1]+=s[1]*e}function wt(n,s=1){je(n)||(n[0]*=s,n[1]*=s)}function Qe(n,s){n[0]=Math.min(Math.max(s[0],n[0]),s[2]),n[1]=Math.min(Math.max(s[1],n[1]),s[3])}function bt(n){return Math.hypot(n[0],n[1])}function xt(n,s){if(!je(n))if(s){const e=bt(n);e&&e>s&&wt(n,s/e)}else ve(n,0,0)}function je(n){return!n[0]&&!n[1]}const Pt=/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[0-9a-f]{4}-[0-9a-f]{12}$/i;function Lt(n){if(typeof n!="string"||!n)return null;const s=n.toLowerCase();return Pt.test(s)&&["8","9","a","b"].indexOf(s.charAt(19))!==-1?s:null}var y,N,U,E,w,ie,ne,re,oe,ce,pe,We,fe,qe,ye,He,me,Ke,ae,Ue,ge,Xe,Se,Ze;class Tt extends l.Plugins.BasePlugin{constructor(e){super(e);c(this,pe);c(this,fe);c(this,ye);c(this,me);c(this,ae);c(this,ge);c(this,Se);c(this,y,null);c(this,N,null);c(this,U,null);c(this,E,null);c(this,w,!1);c(this,ie,void 0);c(this,ne,void 0);c(this,re,void 0);c(this,oe,void 0);c(this,ce,null);a(this,ie,new Promise(i=>{a(this,ne,i)})),a(this,re,new Promise(i=>{a(this,oe,i)}))}init({enabled:e=!1}){a(this,w,e)&&(a(this,y,new at),t(this,y).on("connection",i=>P(this,ae,Ue).call(this,i)).on("open",i=>P(this,ge,Xe).call(this,i)).on("error",i=>P(this,Se,Ze).call(this,i)))}start(){t(this,w)&&(t(this,y).disconnected&&!t(this,y).destroyed&&t(this,y).reconnect(),t(this,U)&&t(this,y).connect(t(this,U)))}stop(){t(this,w)&&t(this,y).disconnect()}connectRemote(e){if(t(this,w)){const i=Lt(e);i&&P(this,ae,Ue).call(this,t(this,y).connect(i))}}sendText(e){t(this,w)&&t(this,E)&&t(this,E).send(e)}outSync({sync:e,requests:i}){t(this,w)&&t(this,E)&&t(this,E).send({type:"sync",sync:e,requests:i})}async*inSync(){for(;t(this,y)&&!t(this,y).disconnected;)yield new Promise(e=>{a(this,ce,e)})}destroy(){t(this,w)&&t(this,y).destroy()}get id(){return t(this,N)}get remote(){return t(this,U)}get open(){return t(this,ie)}get connect(){return t(this,re)}get enabled(){return t(this,w)}}y=new WeakMap,N=new WeakMap,U=new WeakMap,E=new WeakMap,w=new WeakMap,ie=new WeakMap,ne=new WeakMap,re=new WeakMap,oe=new WeakMap,ce=new WeakMap,pe=new WeakSet,We=function(){console.log("open"),t(this,U)||a(this,U,t(this,E).peer),t(this,oe).call(this,t(this,U)),t(this,E).on("close",()=>P(this,fe,qe).call(this)).on("data",e=>P(this,ye,He).call(this,e)).on("error",e=>P(this,me,Ke).call(this,e))},fe=new WeakSet,qe=function(){console.log("close")},ye=new WeakSet,He=function({type:e,sync:i,requests:r}){var o;e==="sync"&&(r!=null&&r.byteLength||i!=null&&i.byteLength)&&((o=t(this,ce))==null||o.call(this,{sync:i,requests:r}))},me=new WeakSet,Ke=function(e){console.error(e)},ae=new WeakSet,Ue=function(e){a(this,E,e),t(this,E).on("open",()=>P(this,pe,We).call(this))},ge=new WeakSet,Xe=function(e){a(this,N,e),t(this,ne).call(this,t(this,N))},Se=new WeakSet,Ze=function(e){console.error(e)};class Ut extends l.Scene{constructor(){super({key:"GameOver"})}preload(){}create(){this.data.set({score:0,lives:3}),this.add.text(200,200,"GAME OVER")}}const kt=["GreenNinja","RedNinja"];class jt extends l.Scene{constructor(){super("Game");I(this,"ecs");I(this,"timer");I(this,"peerjs")}create({mode:e,green:i}){this.scene.launch("UI"),this.data.set({level:0,lives:3}),this.ecs.addSystem("position-request",new yt),this.ecs.addSystem("velocity-request",new gt),this.ecs.addSystem("position-limits",new ft),this.ecs.addSystem("velocity",new vt),this.ecs.addSystem("sprite",new mt({textures:kt}));const r=i===this.peerjs.id||e==="single"?this.ecs.addEntity(De(),Oe(10,0),Ae(64,64),Me(64,64,416,416),Ce(0,0,100)):this.ecs.addEntity(De(),Oe(10,1),Ae(416,416),Me(64,64,416,416),Ce(0,0,100));e==="vs"&&(this.timer=this.time.addEvent({delay:2e3,callback:()=>{this.ecs.request(St(r,l.Math.FloatBetween(-30,30),l.Math.FloatBetween(-30,30)))},loop:!0}),this.outSync(),this.inSync());const o=this.make.tilemap({key:"map"}),u=o.addTilesetImage("TilesetInterior","TilesetInterior"),d=o.addTilesetImage("TilesetInteriorFloor","TilesetInteriorFloor"),m=o.addTilesetImage("TilesetDungeon","TilesetDungeon");o.createLayer("Floor",[d],40,40);const Q=o.createLayer("Walls",[u],40,40),Ie=o.createLayer("Stones",[m],40,40);Q.setCollision([162,166,163,184,210,244,215,179,291,262,279,195,245,276,273,274,246,278,198,280,275,261,193,310,307,311]),Ie.setCollision(739),this.sys.events.on("wake",this.wake,this)}async outSync(){var e,i;for await(const r of this.ecs.outSync())((e=r.sync)!=null&&e.byteLength||(i=r.requests)!=null&&i.byteLength)&&this.peerjs.outSync(r)}async inSync(){var e,i;for await(const r of this.peerjs.inSync())((e=r.sync)!=null&&e.byteLength||(i=r.requests)!=null&&i.byteLength)&&this.ecs.inSync(r)}openMenu(){this.scene.sleep("UI"),this.scene.switch("Menu")}wake(){this.scene.run("UI")}}class It extends l.Scene{constructor(){super({key:"InviteLink"});I(this,"peerjs")}preload(){this.load.image("nine","assets/ui/nine.png"),this.load.image("nineLight","assets/ui/nineLight.png")}create(){const e=new URL(location.href).searchParams.get("r");let i,r;if(e)i=e,r=this.peerjs.id,this.peerjs.connectRemote(e);else{const o=`${location.origin}${location.pathname}?r=${this.peerjs.id}`;console.log(o),i=this.peerjs.id,this.add.nineslice(this.scale.width/2,this.scale.height/2,"nineLight","nineLight",340,340,16,16,16,16);const{modules:{size:u,data:d}}=ht(o),m=Array.from({length:u},(Ie,_e)=>Array.from(d.subarray(u*_e,u*(_e+1))).map(Ve=>45-Ve)),Q=this.make.tilemap({data:m,tileWidth:16,tileHeight:16});Q.createLayer(0,[Q.addTilesetImage("TilesetDungeon")],92,92).setScale(.5)}this.peerjs.connect.then(o=>{this.scene.start("Game",{mode:"vs",green:i,red:r||o})})}}class _t extends l.Scene{constructor(){super({key:"Menu"})}preload(){}create(){}closeMenu(){this.scene.switch("Game")}}class Dt extends l.Scene{constructor(){super({key:"Preload"});I(this,"peerjs")}preload(){this.load.pack("pack","assets/pack.json"),this.load.atlasXML("ui","assets/ui/atlas.png","assets/ui/atlas.xml")}create(){this.peerjs.enabled?this.peerjs.open.then(()=>{this.scene.start("InviteLink")}):this.scene.start("Game",{mode:"single"})}}class At extends l.Scene{constructor(){super({key:"UI"});I(this,"scoreText",null);I(this,"livesText",null)}preload(){}create(){this.data.set({score:0,lives:3}),this.scoreText=this.add.text(44,0,"Score: "+this.data.get("score"),{fontFamily:"Pixel",fontSize:"24px"}),this.livesText=this.add.text(384,0,"Lives: "+this.data.get("lives"),{fontFamily:"Pixel",fontSize:"24px"})}setScore(e){var i;this.data.set("score",e),(i=this.scoreText)==null||i.setText("Score: "+e)}setLives(e){var i;this.data.set("lives",e),(i=this.livesText)==null||i.setText("Lives: "+e)}}class Mt extends l.Game{constructor(s=480,e=480){const i=new URL(location.href).searchParams,r=i.has("peerjs")||!!i.get("r"),o={type:l.WEBGL,width:s,height:e,parent:"game",scale:{mode:l.Scale.FIT,autoCenter:l.Scale.CENTER_BOTH},plugins:{global:[{key:"peerjsPlugin",plugin:Tt,start:!0,mapping:"peerjs",data:{enabled:r}}],scene:[{key:"ecsPlugin",plugin:pt,mapping:"ecs"}]},scene:[Dt,jt,_t,At,Ut,It],backgroundColor:"#141b1b"};super(o)}}window.bomberman=new Mt;
